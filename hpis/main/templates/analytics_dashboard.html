<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - HPIS</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/analytics_dashboard.css' %}">
</head>
<body>

    <header>
        <h1>ðŸ“Š Analytics Dashboard</h1>
        <nav>
            <a href="{% url 'dashboard_url' %}">Dashboard</a>
            <a href="{% url 'analytics_dashboard' %}" class="active">Analytics</a>
            <a href="{% url 'inventory_meds:dashboard' %}">Medicine Inventory</a>
            <a href="{% url 'settings' %}">Settings</a>
            <a href="{% url 'profile' %}">Profile</a>
            <a href="{% url 'user_login' %}">Logout</a>
        </nav>
    </header>

    <div class="container">
        <h2>System Analytics & KPIs</h2>

        <form method="GET" class="filters">
            <label>Date Range:</label>
            <input type="date" id="date-from" name="date_from" value="{{ date_from }}">
            <label>to</label>
            <input type="date" id="date-to" name="date_to" value="{{ date_to }}">

            <label>Department:</label>
            <select id="department" name="department">
                <option value="">All Departments</option>
                <option value="Cardiology" {% if selected_department == 'Cardiology' %}selected{% endif %}>Cardiology</option>
                <option value="General Practice" {% if selected_department == 'General Practice' %}selected{% endif %}>General Practice</option>
                <option value="Emergency" {% if selected_department == 'Emergency' %}selected{% endif %}>Emergency</option>
                <option value="Pediatrics" {% if selected_department == 'Pediatrics' %}selected{% endif %}>Pediatrics</option>
                <option value="Orthopedics" {% if selected_department == 'Orthopedics' %}selected{% endif %}>Orthopedics</option>
            </select>

            <button type="submit">Apply Filters</button>
        </form>

        <div class="kpi-grid">
            <div class="kpi-card positive">
                <div class="kpi-label">Total Appointments</div>
                <div class="kpi-value" data-kpi="total_appointments">{{ total_appointments|default:"0" }}</div>
                <div class="kpi-change {% if total_change >= 0 %}up{% else %}down{% endif %}">
                    {% if total_change >= 0 %}â†‘{% else %}â†“{% endif %} {{ total_change|floatformat:1 }}% vs last month
                </div>
            </div>

            <div class="kpi-card positive">
                <div class="kpi-label">Patient Satisfaction</div>
                <div class="kpi-value" data-kpi="patient_satisfaction">{{ satisfaction_rate|floatformat:1 }}%</div>
                <div class="kpi-change up">Based on completion rate</div>
            </div>

            <div class="kpi-card warning">
                <div class="kpi-label">Average Wait Time</div>
                <div class="kpi-value" data-kpi="avg_wait_time">{{ avg_wait_time|floatformat:1 }} days</div>
                <div class="kpi-change">From request to confirmation</div>
            </div>

            <div class="kpi-card positive">
                <div class="kpi-label">Active Patients</div>
                <div class="kpi-value" data-kpi="active_patients">{{ active_patients|default:"0" }}</div>
                <div class="kpi-change up">Unique patients with appointments</div>
            </div>
        </div>

        <div class="chart-grid">
            <div class="chart-card">
                <h3>Appointments by Type</h3>
                <div class="chart-container">
                    <canvas id="appointmentTypeChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h3>Monthly Appointments Trend</h3>
                <div class="chart-container">
                    <canvas id="appointmentTrendChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h3>Appointment Status Distribution</h3>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h3>Department Workload</h3>
                <div class="chart-container">
                    <canvas id="departmentChart"></canvas>
                </div>
            </div>
        </div>

    </div>

    <footer>
        <p>&copy; 2025 Healthcare Patient Information System. All rights reserved.</p>
    </footer>

    <script>
        // Parse data from Django context
        const monthlyData = {{ monthly_data|safe }};
        const typeLabels = {{ type_labels|safe }};
        const typeCounts = {{ type_counts|safe }};
        const statusLabels = {{ status_labels|safe }};
        const statusCounts = {{ status_counts|safe }};
        const deptLabels = {{ dept_labels|safe }};
        const deptCounts = {{ dept_counts|safe }};

        // Appointment Type Chart (Doughnut)
        const appointmentTypeCtx = document.getElementById('appointmentTypeChart').getContext('2d');
        new Chart(appointmentTypeCtx, {
            type: 'doughnut',
            data: {
                labels: typeLabels.length > 0 ? typeLabels : ['No Data'],
                datasets: [{
                    data: typeCounts.length > 0 ? typeCounts : [1],
                    backgroundColor: ['#1c2f6c', '#2e7d32', '#f57c00', '#d32f2f', '#7b1fa2']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Appointment Trend Chart (Line)
        const trendCtx = document.getElementById('appointmentTrendChart').getContext('2d');
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: monthlyData.map(d => d.month),
                datasets: [{
                    label: 'Appointments',
                    data: monthlyData.map(d => d.count),
                    borderColor: '#1c2f6c',
                    backgroundColor: 'rgba(28, 47, 108, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Status Chart (Bar)
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        new Chart(statusCtx, {
            type: 'bar',
            data: {
                labels: statusLabels.length > 0 ? statusLabels : ['No Data'],
                datasets: [{
                    label: 'Count',
                    data: statusCounts.length > 0 ? statusCounts : [0],
                    backgroundColor: ['#f57c00', '#1976d2', '#2e7d32', '#1c2f6c', '#d32f2f']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Department Chart (Horizontal Bar)
        const departmentCtx = document.getElementById('departmentChart').getContext('2d');
        new Chart(departmentCtx, {
            type: 'bar',
            data: {
                labels: deptLabels.length > 0 ? deptLabels : ['No Data'],
                datasets: [{
                    label: 'Appointments',
                    data: deptCounts.length > 0 ? deptCounts : [0],
                    backgroundColor: '#1c2f6c'
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true
                    }
                }
            }
        });
    </script>

</body>
</html>