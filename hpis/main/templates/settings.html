<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings - HPIS</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'css/settings.css' %}">
</head>
<body>

  <!-- Header -->
  <header>
    <h1>‚öôÔ∏è Settings - HPIS</h1>
    <nav>
      <a href="{% url 'dashboard_url' %}">Dashboard</a>
      <a href="{% url 'analytics_dashboard' %}">Analytics</a>
      <a href="{% url 'inventory_meds:dashboard' %}">üíä Medicine Inventory</a>
      <a href="{% url 'settings' %}" class="active">Settings</a>
      <a href="{% url 'profile' %}">Profile</a>
    </nav>
  </header>

  <!-- Main Container -->
  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <h3>Settings Menu</h3>
      <ul>
        <li><a href="#" class="nav-link active" onclick="showSection('password', event)">Reset Password</a></li>
        <li><a href="#" class="nav-link" onclick="showSection('notifications', event)">Notifications</a></li>
        <li><a href="#" class="nav-link" onclick="showSection('privacy', event)">Data & Privacy</a></li>
        <li><a href="#" class="nav-link" onclick="showSection('logs', event)">Access Logs</a></li>
      </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content">

      <!-- Messages -->
      {% if messages %}
      <div class="messages">
        {% for message in messages %}
          <div class="alert alert-{% if message.tags %}{{ message.tags }}{% else %}success{% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
      {% endif %}

      <!-- Reset Password Section -->
      <div id="password" class="section active">
        <h2>Reset Password</h2>

        <form method="POST" action="{% url 'change_password' %}">
          {% csrf_token %}
          <div class="form-group">
            <label for="oldPassword">Current Password</label>
            <input type="password" id="oldPassword" name="old_password" required>
          </div>

          <div class="form-group">
            <label for="newPassword">New Password</label>
            <input type="password" id="newPassword" name="new_password1" required onkeyup="validatePassword()">
            <ul class="password-requirements">
              <li id="req-length">At least 8 characters</li>
              <li id="req-uppercase">One uppercase letter</li>
              <li id="req-number">One number</li>
              <li id="req-special">One special character (!@#$%)</li>
            </ul>
          </div>

          <div class="form-group">
            <label for="confirmPassword">Confirm Password</label>
            <input type="password" id="confirmPassword" name="new_password2" required>
          </div>

          <div class="btn-group">
            <button type="submit" class="btn-primary">Update Password</button>
            <button type="reset" class="btn-secondary">Clear</button>
          </div>
        </form>
      </div>

      <!-- Notifications Section -->
      <div id="notifications" class="section">
        <h2>Notification Preferences</h2>

        <form method="POST" action="{% url 'update_notifications' %}">
          {% csrf_token %}

          <div class="notification-item">
            <div class="notification-label">
              <strong>Email Notifications</strong>
              <span>Receive appointment reminders via email</span>
            </div>
            <input type="checkbox" name="email_notifications" {% if notification_pref.email_notifications %}checked{% endif %}>
          </div>

          <div class="notification-item">
            <div class="notification-label">
              <strong>SMS Notifications</strong>
              <span>Receive appointment reminders via SMS</span>
            </div>
            <input type="checkbox" name="sms_notifications" {% if notification_pref.sms_notifications %}checked{% endif %}>
          </div>

          <div class="notification-item">
            <div class="notification-label">
              <strong>Prescription Alerts</strong>
              <span>Get notified when prescription refills are available</span>
            </div>
            <input type="checkbox" name="prescription_alerts" {% if notification_pref.prescription_alerts %}checked{% endif %}>
          </div>

          <div class="notification-item">
            <div class="notification-label">
              <strong>System Updates</strong>
              <span>Receive important system and security updates</span>
            </div>
            <input type="checkbox" name="system_updates" {% if notification_pref.system_updates %}checked{% endif %}>
          </div>

          <div class="btn-group">
            <button type="submit" class="btn-primary">Save Preferences</button>
          </div>
        </form>
      </div>

      <!-- Data Privacy Section -->
      <div id="privacy" class="section">
        <h2>Data Privacy & Security</h2>

        <div class="privacy-option">
          <strong>Download Your Data</strong>
          <p>Download a copy of all your personal data in CSV format.</p>
          <a href="{% url 'download_user_data' %}">Download Data</a>
        </div>

        <div class="privacy-option">
          <strong>Request Data Export</strong>
          <p>Request a comprehensive export of all your data (processed within 24 hours).</p>
          <form method="POST" action="{% url 'request_data_export' %}" style="display: inline;">
            {% csrf_token %}
            <button type="submit">Request Export</button>
          </form>
        </div>

        <div class="privacy-option">
          <strong>View Access Logs</strong>
          <p>See a history of all accesses to your account and data.</p>
          <a href="#" onclick="showSection('logs', event)">View Access Logs</a>
        </div>

        <div class="privacy-option">
          <strong>Delete Your Account</strong>
          <p>Permanently delete your account and all associated data. This action cannot be undone.</p>
          <button type="button" class="delete-btn" onclick="showDeleteAccountModal()">Delete Account</button>
        </div>

        <div class="alert alert-info" style="margin-top: 20px;">
          üí° Your data is encrypted and protected according to healthcare privacy standards (HIPAA).
        </div>
      </div>

      <!-- Access Logs Section -->
      <div id="logs" class="section">
        <h2>Access Logs</h2>
        <p style="color: #666; margin-bottom: 20px;">View your recent account activity and security events.</p>

        {% if access_logs %}
        <table class="logs-table">
          <thead>
            <tr>
              <th>Date & Time</th>
              <th>Activity Type</th>
              <th>IP Address</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            {% for log in access_logs %}
            <tr>
              <td>{{ log.timestamp|date:"M d, Y H:i" }}</td>
              <td>{{ log.get_access_type_display }}</td>
              <td>{{ log.ip_address|default:"N/A" }}</td>
              <td>{{ log.description|default:"‚Äî" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="alert alert-info">
          No access logs found.
        </div>
        {% endif %}
      </div>
    </main>
  </div>

  <!-- Delete Account Modal -->
  <div id="deleteAccountModal" class="modal">
    <div class="modal-content">
      <h3>Delete Account</h3>
      <p><strong>‚ö†Ô∏è Warning:</strong> This action is permanent and cannot be undone. Your account will be scheduled for deletion in 30 days after confirmation.</p>

      <form method="POST" action="{% url 'request_account_deletion' %}">
        {% csrf_token %}
        <div class="form-group">
          <label for="reason">Reason for deletion (optional):</label>
          <textarea id="reason" name="reason" placeholder="Tell us why you're leaving..."></textarea>
        </div>

        <div class="modal-buttons">
          <button type="button" class="btn-secondary" onclick="closeModal('deleteAccountModal')">Cancel</button>
          <button type="submit" class="btn-danger">Delete Account</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <a href="#">Contact Us</a>
    <a href="#">Privacy Policy</a>
    <a href="#">Terms of Use</a>
    <p>&copy; 2025 Healthcare Patient Information System. All rights reserved.</p>
  </footer>

  <script src="{% static 'js/settings.js' %}"></script>

</body>
</html>